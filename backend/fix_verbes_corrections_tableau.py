#!/usr/bin/env python3
"""
CORRECTIONS COMPL√àTES DES VERBES SELON LES TABLEAUX UTILISATEUR
=============================================================
Applique toutes les corrections de verbes fournies dans les tableaux
plus la correction sp√©cifique de "mille-pattes"
"""

import os
from pymongo import MongoClient
from dotenv import load_dotenv
from database_protection import protect_database, db_protector

# Charger les variables d'environnement
load_dotenv()

# Configuration MongoDB
MONGO_URL = os.getenv('MONGO_URL', 'mongodb://localhost:27017')
DB_NAME = os.getenv('DB_NAME', 'mayotte_app')

# Corrections extraites des tableaux utilisateur
VERBES_CORRECTIONS = [
    # Premier tableau
    {"french": "jouer", "shimaore": "ounguadza", "kibouchi": "msoma"},
    {"french": "courir", "shimaore": "wendra mbiyo", "kibouchi": "miloumeyi"},
    {"french": "dire", "shimaore": "ourongoa", "kibouchi": "mangnabara"},
    {"french": "pouvoir", "shimaore": "ouchindra", "kibouchi": "mahal√©ou"},
    {"french": "vouloir", "shimaore": "outsaha", "kibouchi": "chokou"},
    {"french": "savoir", "shimaore": "oujoua", "kibouchi": "m√©h√®yi"},
    {"french": "voir", "shimaore": "ouona", "kibouchi": "mahita"},
    {"french": "devoir", "shimaore": "oulazimou", "kibouchi": "tokoutrou"},
    {"french": "venir", "shimaore": "ouja", "kibouchi": "havi"},
    {"french": "rapprocher", "shimaore": "outsengu√©l√©ya", "kibouchi": "magnatougnou"},
    {"french": "prendre", "shimaore": "ourenga", "kibouchi": "mangala"},
    {"french": "donner", "shimaore": "ouva", "kibouchi": "magnamiya"},
    {"french": "parler", "shimaore": "oulagoua", "kibouchi": "mivoulangna"},
    {"french": "mettre", "shimaore": "outria", "kibouchi": "mangnanou"},
    {"french": "passer", "shimaore": "ouvira", "kibouchi": "mihomba"},
    {"french": "trouver", "shimaore": "oupara", "kibouchi": "mahazou"},
    {"french": "aimer", "shimaore": "ouvendza", "kibouchi": "mitiya"},
    {"french": "croire", "shimaore": "ouamini", "kibouchi": "koimini"},
    {"french": "penser", "shimaore": "oufikiri", "kibouchi": "midz√©ri"},
    {"french": "conna√Ætre", "shimaore": "oujoua", "kibouchi": "m√©h√®yi"},
    {"french": "demander", "shimaore": "oudzissa", "kibouchi": "magnoutani"},
    {"french": "r√©pondre", "shimaore": "oudjibou", "kibouchi": "mikoudjibou"},
    {"french": "laisser", "shimaore": "oulicha", "kibouchi": "mangnamb√©la"},
    {"french": "manger", "shimaore": "oudhya", "kibouchi": "mihinagna"},
    {"french": "boire", "shimaore": "ounoua", "kibouchi": "mindranou"},
    {"french": "lire", "shimaore": "ousoma", "kibouchi": "midzorou"},
    {"french": "√©crire", "shimaore": "ouhanguiha", "kibouchi": "mikouandika"},
    {"french": "√©couter", "shimaore": "ouvoulikia", "kibouchi": "mitangr√©ngni"},
    {"french": "apprendre", "shimaore": "oufoundriha", "kibouchi": "midzorou"},
    {"french": "comprendre", "shimaore": "ou√©l√©wa", "kibouchi": "kou√©l√©wa"},
    {"french": "marcher", "shimaore": "ouendra", "kibouchi": "mand√©ha"},
    {"french": "entrer", "shimaore": "ounguiya", "kibouchi": "mihiditri"},
    {"french": "sortir", "shimaore": "oulawa", "kibouchi": "miboka"},
    {"french": "rester", "shimaore": "ouketi", "kibouchi": "mip√©traka"},
    {"french": "vivre", "shimaore": "ouyinchi", "kibouchi": "mikou√®nchi"},
    {"french": "dormir", "shimaore": "ulala", "kibouchi": "mandri"},
    {"french": "attendre", "shimaore": "oulindra", "kibouchi": "mandigni"},
    {"french": "suivre", "shimaore": "oulounga", "kibouchi": "mangnaraka"},
    {"french": "tenir", "shimaore": "oussika", "kibouchi": "mitana"},
    {"french": "ouvrir", "shimaore": "ouboua", "kibouchi": "mampibiyangna"},
    {"french": "fermer", "shimaore": "oubala", "kibouchi": "migadra"},
    {"french": "sembler", "shimaore": "oufana", "kibouchi": "mamhiragna"},
    {"french": "para√Ætre", "shimaore": "ouwonehoua", "kibouchi": "ouhitagna"},
    {"french": "devenir", "shimaore": "ougawouha", "kibouchi": "mivadiki"},
    {"french": "tomber", "shimaore": "oupouliha", "kibouchi": "latsaka"},
    {"french": "se rappeler", "shimaore": "ouma√©zi", "kibouchi": "koufahamou"},
    {"french": "commencer", "shimaore": "ouhandrissa", "kibouchi": "mitaponou"},
    {"french": "finir", "shimaore": "oumalidza", "kibouchi": "mank√©fa"},
    {"french": "r√©ussir", "shimaore": "ouchindra", "kibouchi": "mahal√©ou"},
    {"french": "essayer", "shimaore": "oudj√©r√©bou", "kibouchi": "mikoudj√©r√©bou"},
    {"french": "attraper", "shimaore": "oubara", "kibouchi": "missamboutrou"},
    {"french": "flatuler", "shimaore": "oujamba", "kibouchi": "mangu√©toutrou"},
    {"french": "traverser", "shimaore": "ouchiya", "kibouchi": "mitsaka"},
    {"french": "sauter", "shimaore": "ouarouka", "kibouchi": "mivongna"},
    {"french": "frapper", "shimaore": "ourema", "kibouchi": "mamangou"},
    {"french": "faire caca", "shimaore": "ougna madzi", "kibouchi": "mangu√©ri"},
    {"french": "faire pipi", "shimaore": "ougna kojo", "kibouchi": "mamani"},
    {"french": "vomir", "shimaore": "ou raviha", "kibouchi": "mandouwa"},
    {"french": "s'asseoir", "shimaore": "ouketi", "kibouchi": "mip√©traka"},
    {"french": "danser", "shimaore": "ouzina", "kibouchi": "mitsindzaka"},
    {"french": "arr√™ter", "shimaore": "ouziya", "kibouchi": "mitsahatra"},
    {"french": "vendre", "shimaore": "ouhoudza", "kibouchi": "mandafou"},
    {"french": "cracher", "shimaore": "outra marr√©", "kibouchi": "mandrora"},
    {"french": "mordre", "shimaore": "ouka magno", "kibouchi": "mangn√©kitri"},
    {"french": "gratter", "shimaore": "oukouwa", "kibouchi": "mihotrou"},
    {"french": "embrasser", "shimaore": "ounouka", "kibouchi": "mihoroukou"},
    {"french": "jeter", "shimaore": "ouvoutsa", "kibouchi": "manopi"},
    {"french": "avertir", "shimaore": "outahadaricha", "kibouchi": "mampah√©yi"},
    {"french": "informer", "shimaore": "oujoudza", "kibouchi": "mangnabara"},
    {"french": "se laver le derri√®re", "shimaore": "outsamba", "kibouchi": "mambouyi"},
    {"french": "se laver", "shimaore": "ouhowa", "kibouchi": "miss√©ki"},
    {"french": "piler", "shimaore": "oudoudoua", "kibouchi": "mandissa"},
    {"french": "changer", "shimaore": "ougaoudza", "kibouchi": "mamadiki"},
    {"french": "√©tendre au soleil", "shimaore": "ouaniha", "kibouchi": "manapi"},
    {"french": "r√©chauffer", "shimaore": "ouhelesedza", "kibouchi": "mamana"},
    {"french": "se baigner", "shimaore": "ouhowa", "kibouchi": "miss√©ki"},
    {"french": "faire le lit", "shimaore": "ouhodza", "kibouchi": "mandzari koubani"},
    
    # Deuxi√®me tableau
    {"french": "faire s√©cher", "shimaore": "ouhoumisa", "kibouchi": "manapi"},
    {"french": "balayer", "shimaore": "ouhoundza", "kibouchi": "mamafa"},
    {"french": "couper", "shimaore": "oukatra", "kibouchi": "manapaka"},
    {"french": "tremper", "shimaore": "oulodza", "kibouchi": "mandzoubougnou"},
    {"french": "se raser", "shimaore": "oumea ndrevu", "kibouchi": "manapaka somboutrou"},
    {"french": "ab√Æmer", "shimaore": "oumengna", "kibouchi": "mandroubaka"},
    {"french": "acheter", "shimaore": "ounounoua", "kibouchi": "mivanga"},
    {"french": "griller", "shimaore": "ouwoha", "kibouchi": "mitonou"},
    {"french": "allumer", "shimaore": "oupatsa", "kibouchi": "mikoupatsa"},
    {"french": "se peigner", "shimaore": "oupengn√©", "kibouchi": "mip√®ngni"},
    {"french": "cuisiner", "shimaore": "oupiha", "kibouchi": "mahandrou"},
    {"french": "ranger/arranger", "shimaore": "ourengu√©l√©dza", "kibouchi": "magnadzari"},
    {"french": "tresser", "shimaore": "oussouka", "kibouchi": "mitali/mandrari"},
    {"french": "peindre", "shimaore": "ouvaha", "kibouchi": "magnossoutrou"},
    {"french": "essuyer", "shimaore": "ouvangouha", "kibouchi": "mamitri"},
    {"french": "amener/apporter", "shimaore": "ouvinga", "kibouchi": "mand√®yi"},
    {"french": "√©teindre", "shimaore": "ouzima", "kibouchi": "mamounou"},
    {"french": "tuer", "shimaore": "ouwoula", "kibouchi": "mamounou"},
    {"french": "combler", "shimaore": "oufitsiya", "kibouchi": "mankahampi"},
    {"french": "cultiver", "shimaore": "oulima", "kibouchi": "mikapa"},
    {"french": "couper du bois", "shimaore": "oupasouha kuni", "kibouchi": "mamaki azoumati"},
    {"french": "cueillir", "shimaore": "oupoua", "kibouchi": "mampoka"},
    {"french": "planter", "shimaore": "outabou", "kibouchi": "mamboli"},
    {"french": "creuser", "shimaore": "outsimba", "kibouchi": "mangadi"},
    {"french": "r√©colter", "shimaore": "ouvouna", "kibouchi": "mampoka"},
    {"french": "bouger", "shimaore": "outsengu√©l√©ya", "kibouchi": "mit√©ki"},
    {"french": "arnaquer", "shimaore": "ou ravi", "kibouchi": "mangalatra"},
]

# Correction sp√©cifique pour mille-pattes
MILLE_PATTES_CORRECTION = {
    "french": "mille-pattes",
    "shimaore": "mjongo", 
    "kibouchi": "ancoudavitri"
}

@protect_database("fix_verbes_corrections_tableau")
def apply_verbes_corrections():
    """Applique toutes les corrections de verbes des tableaux"""
    print("üîß APPLICATION DES CORRECTIONS DE VERBES DES TABLEAUX UTILISATEUR")
    print("=" * 80)
    
    try:
        client = MongoClient(MONGO_URL)
        client.admin.command('ping')
        print(f"‚úÖ Connexion MongoDB √©tablie : {MONGO_URL}")
    except Exception as e:
        print(f"‚ùå Erreur de connexion MongoDB : {e}")
        return False
    
    db = client[DB_NAME]
    words_collection = db.words
    
    corrections_applied = 0
    corrections_failed = 0
    new_words_added = 0
    
    # Ajouter d'abord la correction de mille-pattes
    all_corrections = VERBES_CORRECTIONS + [MILLE_PATTES_CORRECTION]
    
    for correction in all_corrections:
        french = correction["french"]
        shimaore = correction["shimaore"]
        kibouchi = correction["kibouchi"]
        
        print(f"\nüîç Recherche de '{french}'...")
        
        # Chercher le mot existant (insensible √† la casse)
        existing_word = words_collection.find_one({
            "french": {"$regex": f"^{french}$", "$options": "i"}
        })
        
        if existing_word:
            # V√©rifier si une correction est n√©cessaire
            needs_update = False
            update_fields = {}
            
            current_shimaore = existing_word.get("shimaore", "").strip()
            current_kibouchi = existing_word.get("kibouchi", "").strip()
            
            if current_shimaore != shimaore:
                update_fields["shimaore"] = shimaore
                needs_update = True
                print(f"  üìù Shimaor√©: '{current_shimaore}' ‚Üí '{shimaore}'")
            
            if current_kibouchi != kibouchi:
                update_fields["kibouchi"] = kibouchi
                needs_update = True
                print(f"  üìù Kibouchi: '{current_kibouchi}' ‚Üí '{kibouchi}'")
            
            if needs_update:
                # Appliquer la correction
                result = words_collection.update_one(
                    {"_id": existing_word["_id"]},
                    {"$set": update_fields}
                )
                
                if result.modified_count > 0:
                    print(f"  ‚úÖ Correction appliqu√©e pour '{french}'")
                    corrections_applied += 1
                else:
                    print(f"  ‚ùå √âchec de la correction pour '{french}'")
                    corrections_failed += 1
            else:
                print(f"  ‚úì '{french}' est d√©j√† correct")
        else:
            # Mot non trouv√© - d√©terminer la cat√©gorie appropri√©e
            if french == "mille-pattes":
                category = "animaux"
            elif french in ["ranger/arranger", "amener/apporter", "couper du bois"]:
                category = "verbes"
            else:
                category = "verbes"  # Par d√©faut pour les verbes
            
            new_word = {
                "french": french,
                "shimaore": shimaore,
                "kibouchi": kibouchi,
                "category": category,
                "difficulty": 1,
            }
            
            # Ajouter le nouveau mot
            result = words_collection.insert_one(new_word)
            if result.inserted_id:
                print(f"  ‚ûï Nouveau mot ajout√©: '{french}' (cat√©gorie: {category})")
                new_words_added += 1
            else:
                print(f"  ‚ùå √âchec de l'ajout du nouveau mot '{french}'")
                corrections_failed += 1
    
    print("\n" + "=" * 80)
    print("üìä R√âSUM√â DES CORRECTIONS DE VERBES:")
    print(f"‚úÖ Corrections appliqu√©es: {corrections_applied}")
    print(f"‚ûï Nouveaux mots ajout√©s: {new_words_added}")
    print(f"‚ùå √âchecs: {corrections_failed}")
    print(f"üìù Total trait√©: {len(all_corrections)}")
    
    # V√©rification finale de l'int√©grit√©
    print("\nüîç V√©rification de l'int√©grit√© post-corrections...")
    is_healthy, message = db_protector.is_database_healthy()
    if is_healthy:
        print("‚úÖ Base de donn√©es saine apr√®s corrections")
    else:
        print(f"‚ö†Ô∏è Probl√®me d√©tect√©: {message}")
    
    client.close()
    return corrections_applied > 0 or new_words_added > 0

if __name__ == "__main__":
    print("üöÄ D√©marrage de l'application des corrections de verbes des tableaux...")
    
    # V√©rifier l'√©tat initial
    print("\nüîç V√©rification de l'√©tat initial de la base de donn√©es...")
    is_healthy, message = db_protector.is_database_healthy()
    if not is_healthy:
        print(f"‚ö†Ô∏è Probl√®me d√©tect√© avant corrections: {message}")
        print("üîÑ Restauration recommand√©e avant d'appliquer les corrections")
        exit(1)
    
    # Appliquer les corrections
    success = apply_verbes_corrections()
    
    if success:
        print("\nüéâ CORRECTIONS DE VERBES APPLIQU√âES AVEC SUCC√àS!")
        print("‚úÖ La base de donn√©es a √©t√© mise √† jour avec toutes les corrections des tableaux")
        print("‚úÖ 'mille-pattes' corrig√© avec 'mjongo' (shimaor√©) et 'ancoudavitri' (kibouchi)")
        
        # V√©rification finale de l'int√©grit√©
        print("\nüîç V√©rification finale de l'int√©grit√©...")
        is_healthy_after, message_after = db_protector.is_database_healthy()
        if is_healthy_after:
            print("‚úÖ Base de donn√©es saine apr√®s corrections")
        else:
            print(f"‚ö†Ô∏è Probl√®me d√©tect√© apr√®s corrections: {message_after}")
    else:
        print("\n‚ö†Ô∏è Aucune correction n'a √©t√© appliqu√©e")
    
    print("\nFin du script de corrections de verbes.")